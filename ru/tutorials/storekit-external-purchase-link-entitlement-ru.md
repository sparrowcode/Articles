# Механизм внешних покупок по ссылке в StoreKit

Apple разрешила направлять пользователей из РФ на оплату цифровых покупок в приложении и подписок из приложения на **внешнем** сайте, минуя AppStore payments. Но чтобы вы могли это делать, сначала нужно подать заявку, получить разрешение и, конечно, соответствующим образом обновить приложения.

Это пошаговая инструкция от разработчиков в которой мы расскажем с какими проблемами столкнулись, это сэкономит вам время.

Но, прежде чем внедрять внешние цифровые покупки, следует взвесить все за и против, которые лежат не только в технической, но и в организационно-правовой плоскости. Для этого рекомендуем ознакомиться также с нашей статьёй: ["Первыми в App Store внедрили оплату подписки на расчётный счет ООО в РФ"](https://vc.ru/u/rentel/1024516-pervymi-v-app-store-vnedrili-oplatu-podpiski-na-raschetnyy-schet-ooo-v-rf)


>[!Note] Внутри одного региона вы не можете одновременно принимать и внешние платежи, и классические платежи через App Store. Нужно выбрать что-то одно.

>[!Tip] Кстати, механизм внешних покупок впервые стал доступен для Голландии, затем для России, и вскоре после этого в США. Не исключено, что перечень стран будет расширен.

## Виды внешних покупок

Нужно различать два вида внешних покупок:
  
- **External Purchase** - внешняя покупка осуществляется в интерфейсе приложения, без переходов куда либо. Проще говоря, например, данные карты предлагается ввести на одном из экранов.
- **External Purchase Link** - после системного предупреждения, о том, что Apple больше не отвечает за то, кому вы отправите свои деньги, вас перебрасывает на сайт, где как в обычном интернет-магазине вы можете сделать цифровую покупку. *Этот способ более универсален, но чуть менее удобен: вам нужен сайт-магазин и синхронизация приложения с ним. В случае, если бы всё происходило внутри приложения, можно было бы обойтись без этого звена, приложение могло бы в моменте отследить успешную оплату. Также это позволило бы автоматически генерировать отчётность, необходимую для отчисления процента с цифровых покупок.*

  В данном документе речь пойдёт о External Purchase **Link**. 
# Заявка

Заявка это что-то вроде анкеты, большинство полей заполняется автоматически. Подавать заявку [по этой ссылке](https://developer.apple.com/contact/request/storekit-external-entitlement-ru).

>[!Note] Эта ссылка для подачи зявки может работать не для всех учётных записей. Скорее всего регион разработчика должен быть среди регионов, в которых резрешены внешние покупки. Также может быть нужно, чтобы разработчик представлял компанию (юридическое лицо) 

[xx2]

> Обязательно нужно принять соглашение о платных приложениях, иначе форма заявки не откроется.

Дальше в заявке введите название приложения (локализация не важна), Bundle ID и описание. Здесь мы написали что наши клиенты из РФ и хотим сделать нашим клиентам удобно.[xx3]

![Заполняете данные о приложении](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/request-app-info.jpg)

Следующий шаг — указать ваш эквайринг:

![Указываете ваш эквайринг](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/reqeust-payment-processing.jpg)

>[!Note] Проверяйте чтобы эквайринг был не под санкциями. Нашу заявку отклонили, потому что мы указали ЮКассу.

Теперь указываете информация о веб-сайте, здесь нужно указать страницу оплаты (куда будете направлять пользователей) и страницу поддержки по вопросам платежей.

![Заполняете данные о приложении](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/request-website-info.jpg)

[xx5]

> URL в заявке должен совпадать с реальными ссылками. Эти URL вы будете добавлять в `Info.plist`.

>[!Note] На момент написания инструкции действует требование, согласно которому ссылка может содержать только путь. В ней не должно быть никаких параметров и меток.

Последний шаг — заполнить информацию о компании, заполнется руководителем:

[xx6]

# Проверка заявки

Нашу заявку отклонили через 7 дней. Причиной стало то, что предложенный нами эквайринг ЮКасса находился под санкциями. Мы сменили эквайринг на Райффайзен, заполнили новую заявку, но отправить её не смогли — наша старая заявка всё еще висела в статусе рассмотрения.

Около месяца ушло на коммуникацию с Apple через eurodev@apple.com, чтобы аннулировать первую отклонённую заявку, которая фактически блокировала повторную подачу. Возможно этот недочёт к настоящему моменту исправлен, но не факт.

Через 7 дней после успешной повторной отправки заявку, в App Store Connect [xx7] стала доступна новая возможность в разделе `Additional Capabilities` для бандла приложения.

> Уведомлений на почту не девелопер не получал, поэтому совет: проверяйте раздел Developer / Certifies, Identifiers & Profiles время от времени после успешной отправки заявки.

Всё что остаётся сделать на стороне App Store Connect – внутри `Additional Capabilities` выбрать `ExternalPurchaseLink` и применить изменения. Далее нужно интегрировать эту редкую capabilty в приложение.  

# Настраиваем приложение

В Xcode в списке Capability появится новоя "StoreKit External Purchase Link Entitlement (RU)", нужно добавить её к приложению:

![Добавляете Capability](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/capability.jpg)

В `Info.plist` добавляем ключ со словарём. В словаре указываем ссылку на оплату на сайте, для каждой страны своя ссылка:

``` xml
  <key>SKExternalPurchaseLink</key>
  <dict>
    <key>ru</key>
    <string>https://rentel.app/price</string>
  </dict>
```

Аббревиатура  страны – по стандарту ISO.

В коде сайт внешних покупок надо открывать не как ссылку, а вызывать `try await ExternalPurchaseLink.open()` из `StoreKit`. Пользователю покажут системный диклеймер, что “полномочия Apple всё”, и если что-то пойдёт не так, разбираться с разработчиком придётся самостоятельно.

[xx9]

# Проверка приложения

Обязательно в поле комментарий прикрепить видео, где видно процесс авторизации, окно со встроенными покупками и переход на сайт. Обязательно показать что URL совпадает с URL в заявке.

> В гайдах говорят про скриншот, но нас попросили именно видео.

Видео можно залить на хостинг, и в коментарий указать ссылку. Коментарий для ревьюера не пропадает между версиями, так что сделать это придется один раз.

Мы отправили билд на проверку, но получили реджект. Правила для UI к этому моменту  обновили, возможно, в будущем будут ещё обновления. Выяснилось, что нельзя показывать тарифы в самом приложении, только кнопку на сайт для платежа. Оформили в точности как в примере для американского референса для аналогичной capability. Даже иконку внешней ссылки не забыли. Кстати, символа иконки на момент написания инструкции нет в SFSymbols, поэтому ниже в статье есть ссылка на картинку в векторе.

![Добавляете Capability](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/reject.jpg)

Мы обновили приложение и прошли в App Store:

[Rentel в App Store](https://apps.apple.com/app/id1632637156): Здесь описание приложения

На странице приложения в AppStore появилась вот такая метка. Мне бы больше понравился жёлтый восклицательный знак, но что поделать.

![Добавляете Capability](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/appstore-app-preview.jpg)

# Комиссия. Как платим

Каждый месяц мы отправляем отчеты по форме Apple о покупках. На основе отчетов в личном кабинете появляются счета за комиссию, 27%.

[xx10]

# Замечания и дополнения

Механизм внешних покупок доступен начиная с target 15.4.

Если ваше приложение уже давно в AppStore, то с переходом на новую систему оплату на некоторые пользователи могут испытать сбои при обновлении. Возможно, это баг старших версий iOS. Нам известен как минимум один случай, когда, чтобы обновить приложение, пришлось не просто удалить его с устройства, а ещё и удалить из покупок пользователя.
# Ссылки по теме

[Официальная Инструкция для RU](https://developer.apple.com/contact/request/storekit-external-entitlement-ru): Официальная инструкция и запрос StoreKit Entitlement. Ссылка открывается только с владельца аккаунта и регионом РФ. [xx1]
[Инструкиция для US](https://developer.apple.com/support/storekit-external-entitlement-us/): Не для RU региона, но внутри полезные скриншоты.
[Скачать иконку](https://developer.apple.com/support/downloads/Link-out-template.zip): Оригинальная иконка для кнопки на оплату на сайте.

